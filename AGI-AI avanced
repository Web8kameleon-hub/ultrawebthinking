const tf = require('@tensorflow/tfjs-node');
const express = require('express');
const http = require('http');
const WebSocket = require('ws');
const redis = require('redis');
const bodyParser = require('body-parser');

const app = express();
const port = 8000;
const server = http.createServer(app);
const wss = new WebSocket.Server({ server });
const redisClient = redis.createClient(); // Redis pÃ«r caching tÃ« shpejtÃ«

app.use(bodyParser.json());

let cachedModel = null; // Ruajtja e modelit nÃ« memorie

// **1ï¸âƒ£ Inicimi i Modelit tÃ« AGI**
const loadModel = async () => {
    if (cachedModel) {
        console.log("âš¡ Po pÃ«rdoret modeli i cache-uar!");
        return cachedModel;
    }

    console.log("ğŸš€ Po ngarkohet modeli AGI...");
    cachedModel = await tf.loadLayersModel('file://path/to/your/model/model.json');
    console.log("âœ… Modeli i ngarkuar me sukses!");
    return cachedModel;
};

// **2ï¸âƒ£ Funksioni pÃ«r tÃ« bÃ«rÃ« parashikime AI nÃ« kohÃ« reale**
const makePrediction = async (model, inputData) => {
    const inputTensor = tf.tensor2d([inputData]);
    const prediction = model.predict(inputTensor);
    return prediction.dataSync();
};

// **3ï¸âƒ£ InteligjencÃ« Evolutive â€“ AGI qÃ« mÃ«son dhe pÃ«rshtatet**
const trainModel = async (model, trainingData, labels) => {
    const xs = tf.tensor2d(trainingData);
    const ys = tf.tensor2d(labels);
    
    await model.fit(xs, ys, {
        epochs: 15, // Rritja e epokave pÃ«r mÃ«sim mÃ« tÃ« thelluar
        callbacks: {
            onEpochEnd: (epoch, logs) => console.log(`ğŸ”„ Epoch ${epoch}: Loss = ${logs.loss}`)
        }
    });

    console.log("ğŸ§  Modeli AGI Ã«shtÃ« trajnuar dhe optimizuar!");
    cachedModel = model; // PÃ«rditÃ«so modelin nÃ« cache
};

// **4ï¸âƒ£ Endpoint API pÃ«r AGI**
app.get('/predict', async (req, res) => {
    const model = await loadModel();
    const inputData = req.query.input.split(',').map(parseFloat); // Lejon mÃ« shumÃ« se njÃ« input
    const cacheKey = `prediction:${inputData.join(',')}`;

    // Kontrollo nÃ« Redis nÃ«se ky parashikim ekziston
    redisClient.get(cacheKey, async (err, cachedData) => {
        if (cachedData) {
            console.log("âš¡ Parashikimi u kthye nga cache!");
            return res.json({ prediction: JSON.parse(cachedData) });
        }

        const prediction = await makePrediction(model, inputData);
        redisClient.setex(cacheKey, 60, JSON.stringify(prediction)); // Ruaje nÃ« cache pÃ«r 60 sekonda
        res.json({ prediction });
    });
});

// **5ï¸âƒ£ WebSocket pÃ«r komunikim ultra tÃ« shpejtÃ«**
wss.on('connection', async (ws) => {
    console.log("ğŸ”— Klient i lidhur me AGI!");

    ws.on('message', async (message) => {
        const model = await loadModel();
        const inputData = JSON.parse(message);
        const prediction = await makePrediction(model, inputData);

        ws.send(JSON.stringify({ prediction }));
    });

    ws.on('close', () => console.log("âŒ Klienti u shkÃ«put!"));
});

// **6ï¸âƒ£ Auto-trajnim pÃ«r AGI me tÃ« dhÃ«na tÃ« reja nga pÃ«rdoruesit**
app.post('/train', async (req, res) => {
    const { trainingData, labels } = req.body;
    const model = await loadModel();

    await trainModel(model, trainingData, labels);
    res.json({ message: "ğŸ§  Modeli u pÃ«rditÃ«sua me sukses!" });
});

// **7ï¸âƒ£ Nisja e serverit**
server.listen(port, () => {
    console.log(`ğŸš€ AGI Web8 po dÃ«gjon nÃ« portin ${port}!`);
});